# Maintainer's Runbook

This documents common maintenance tasks for this codebase, to make ongoing maintenance less dependent on any single individual.

## Releasing New Versions

Release a new version using the [Release workflow](https://github.com/block/elasticgraph/actions/workflows/release.yaml).

* Click "Run workflow"
* Select a branch to release from
* Specify a version number (based on our [versioning policy](https://block.github.io/elasticgraph/guides/versioning-policy/))
* Click "Run workflow"

> [!TIP]
> A "Dry Run" option is also available. It's primarily intended for use when testing changes to the Release workflow. It does the
> release actions which are reversible (e.g. bumping the version, pushing a branch, opening a PR, generating draft release notes)
> while skipping the one action that's not reversible (actually releasing to rubygems.org). When used, please remember to cleanup
> afterwards: close the PR and delete the draft release notes.

> [!Important]
> If there's any question about the readiness to release a new version to end users, please release a release candidate
> using a version number like `1.2.0.rc1`, `1.2.0.rc2`, etc. After the release candidate has been thorougly tested, we
> can cut the final release.

After the workflow completes, review the PR that gets opened ([example](https://github.com/block/elasticgraph/pull/618)) and follow its
checklist. The release notes can be authored after cutting a release if needed (but it's nice to have them ready to go if possible).

## Release Notes

Over time, we hope to automate the authoring of release notes using AI, but for now they are still (largely) written by hand. They should
follow this general structure:

```markdown
ElasticGraph vX.Y.Z has been released! This release includes...

## New Features

Describe major new features here with a subheading dedicated to each.

## Upgrade notes

Describe how to upgrade ElasticGraph from the prior version.

## What's Changed

<In this section we provide bullet-point lists linking to each PR, but we often combine many PRs into a single bullet point.>

### New Features

...

### Breaking Changes

...

### Performance Optimizations

...

### Bug Fixes

...

### Other Improvements

...

### Dependency Upgrades

The datastore versions we build against have been upgraded:

...

The following Ruby gems have been upgraded:

...

The following GitHub actions have been upgraded:

...

The following NPM packages have been upgraded:

...

The following Python packages have been upgraded:

...

## New Contributors
* List new contributors here; the auto generated release notes provide this

**Full Changelog**: <GitHub compare URL provided by autogenerated release notes>
```

> [!IMPORTANT]
> We're threading the needle here between acknowledging every contribution (we want to acknowledge contributors!) and keeping the release
> notes at an appropriate level of detail for our user base. Users generally don't care about internal improvements to the ElasticGraph
> codebase that have zero impact on the experience of using ElasticGraph. That's why we often combine many PRs into a single bullet point
> like "Various other codebase maintenance tasks".

> [!NOTE]
> For a pre-release (e.g. `X.Y.Z.rc1`), we generally don't bother writing up release notes, since it takes effort and we don't expect users
> to use pre-releases. Instead, we just use the autogenerated release notes provided by GitHub.
>
> Later, when releasing the final version (e.g. `X.Y.Z`), be sure to include everything, including things that were actually released in
> the release candidate.

For a good example of release notes, see the [v0.19.2.0 release notes](https://github.com/block/elasticgraph/releases/tag/v0.19.2.0).

## Upgrading Elasticsearch/OpenSearch

We want ElasticGraph to stay up-to-date with the latest Elasticsearch/OpenSearch versions. We don't bother keeping up to date
with every patch release, but do want to stay current with the latest major/minor releases. However, we always opt for the
most recent patch release when upgrading.

In addition, we don't want to bloat our CI build by building against *every* supported Elasticsearch/OpenSearch version.
Instead, we cover a *range* of versions by building against a minimum version and a maximum version.

* Find Elasticsearch releases on the [Elastic.co docker page](https://www.docker.elastic.co/r/elasticsearch)
* Find OpenSearch releases on the [Docker Hub page](https://hub.docker.com/r/opensearchproject/opensearch/tags)

To upgrade a version, update the versions in [elasticgraph-local/lib/elastic_graph/local/tested_datastore_versions.yaml](elasticgraph-local/lib/elastic_graph/local/tested_datastore_versions.yaml). Then run:

```bash
script/update_ci_yaml
```

See https://github.com/block/elasticgraph/pull/545 for an example PR.

## Dependabot

We use [Dependabot](https://docs.github.com/en/code-security/getting-started/dependabot-quickstart-guide) to automatically keep dependencies
up-to-date. Our [dependabot config](https://github.com/block/elasticgraph/blob/main/.github/dependabot.yml) configures the cadence of
dependabot updates (among other things)--feel free to tweak it as needed.

### Dependabot PRs

We have some custom tooling that hooks into Dependabot PRs and updates some other artifacts:

* [script/update_gem_constraints](https://github.com/block/elasticgraph/blob/main/script/update_gem_constraints) updates constraints in our
  gemspecs. Dependabot only updates the version in `Gemfile`/`Gemfile.lock`, leaving our gemspec constraints untouched. However, it helps
  avoid surprises for ElasticGraph users if they get the same gem versions our CI runs against, so we want the constraints in our gemspecs
  to be updated to match.
* [workflows/update-gem-version-artifacts.yaml](https://github.com/block/elasticgraph/blob/main/.github/workflows/update-gem-version-artifacts.yaml)
  runs on Dependabot PRs. It runs `script/update_gem_constraints`, updates [rbs_collection.lock.yaml](https://github.com/block/elasticgraph/blob/main/rbs_collection.lock.yaml),
  and pushes a commit to the PR.

Dependabot PRs can be reviewed and merged without the approval of another maintainer. Before merging, please:

* Review the release notes provided by Dependabot in the PR description. If there are any new features of a dependency that we should
  take advantage of, please [open an issue](https://github.com/block/elasticgraph/issues/new/choose) so we can track that work.
* Confirm the CI build fully passes.
* Review the diff to make sure it looks reasonable.

When merging, please use the "Squash and merge" option as we don't need to keep the two commits in the PR separate.

### Triggering Dependabot

Dependabot is configured to run on a regular cadence, but if you ever need to trigger it by hand (e.g. to troubleshoot a problem
with it), you can do so from the [Dependency Graph--Dependabot page](https://github.com/block/elasticgraph/network/updates):

* Click "Recent update jobs" next to a dependabot job
* Click the "Check for updates" button
