#!/usr/bin/env ruby

require "pathname"
require "rubygems"
require "yaml"

module ElasticGraph
  class CIYamlUpdater
    PROJECT_ROOT = ::Pathname.new(::File.expand_path("..", __dir__))
    CI_YAML_PATH = PROJECT_ROOT / ".github" / "workflows" / "ci.yaml"

    def initialize
      @content = CI_YAML_PATH.read
      @versions_data = load_versions_data
    end

    def update
      write_yaml(updated_content)
    end

    def verify
      if @content == updated_content
        puts "✅ #{CI_YAML_PATH} is up-to-date."
        true
      else
        show_diff
        false
      end
    end

    private

    def updated_content
      content = @content.dup
      content = update_datastore_matrix(content)
      content = update_includes_primary_datastore(content)
      content = update_run_datastore_specs_includes(content)
      update_opensearch_version(content)
    end

    def non_primary_datastore_versions
      datastore_versions - [primary_datastore_version]
    end

    def show_diff
      tmp_path = PROJECT_ROOT / "tmp" / "ci.yaml"
      FileUtils.mkdir_p(tmp_path.dirname)
      tmp_path.write(updated_content)

      diff = `git diff --no-index #{CI_YAML_PATH} #{tmp_path} #{" --color" unless ENV["CI"]}`

      puts "❌ #{CI_YAML_PATH} is out-of-date. Run `#{__FILE__}` to update it. Diff:"
      puts
      puts diff
    end

    def load_versions_data
      versions_file = PROJECT_ROOT / "config" / "tested_datastore_versions.yaml"
      YAML.safe_load_file(versions_file)
    end

    def datastore_versions
      @datastore_versions ||= @versions_data.flat_map do |backend, versions|
        versions.map { |version| "#{backend}:#{version}" }
      end
    end

    def primary_datastore_version
      @primary_datastore_version ||= begin
        primary_version = @versions_data.fetch("elasticsearch").max_by do |version|
          Gem::Version.new(version)
        end
        "elasticsearch:#{primary_version}"
      end
    end

    def latest_opensearch_version
      @latest_opensearch_version ||= @versions_data.fetch("opensearch").max_by do |version|
        Gem::Version.new(version)
      end
    end

    def update_datastore_matrix(content)
      # Matrix now has single primary datastore only.
      # Non-primary datastores use run_datastore_specs via includes.
      matrix_pattern = /(        datastore:\n)([^\n]*\n)*?        include:/m
      match = content.match(matrix_pattern)
      return content unless match

      matrix_start = match[1]
      new_version = '          - "' + primary_datastore_version + "\"\n"
      content.sub(matrix_pattern, "#{matrix_start}#{new_version}        include:")
    end

    def update_includes_primary_datastore(content)
      # Update ALL datastore entries in includes section to primary.
      # run_datastore_specs entries will be overridden by update_run_datastore_specs_includes.
      parts = content.split(/^        include:\n/, 2)
      return content unless parts.size == 2

      updated = parts[1].gsub(/(?<=datastore: ")[^"]+(?=")/, primary_datastore_version)
      parts[0] + "        include:\n" + updated
    end

    def update_run_datastore_specs_includes(content)
      # Override run_datastore_specs entries with non-primary datastores
      versions = non_primary_datastore_versions
      idx = 0
      content.gsub(/(?<=build_part: "run_datastore_specs"\n            ruby: "4.0"\n            datastore: ")[^"]+(?=")/) do
        version = versions[idx]
        idx += 1
        version
      end
    end

    def update_opensearch_version(content)
      # Update the OpenSearch version in the docker-demo job
      content.sub(
        /(?<=OPENSEARCH_VERSION: ")[^"]+(?="\n)/,
        latest_opensearch_version
      )
    end

    def write_yaml(content)
      CI_YAML_PATH.write(content)
      puts "#{CI_YAML_PATH} updated."
    end
  end
end

updater = ElasticGraph::CIYamlUpdater.new

case ARGV.first
when "--verify"
  exit(1) unless updater.verify
when nil
  updater.update
else
  raise "Unknown argument: #{ARGV.first}. Expected `--verify` or nothing."
end
